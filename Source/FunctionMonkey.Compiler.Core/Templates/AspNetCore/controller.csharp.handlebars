using System.Threading.Tasks;
using AzureFromTheTrenches.Commanding.Abstractions;
using Microsoft.AspNetCore.Mvc;
{{#if ValidatesToken}}
using Microsoft.AspNetCore.Authorization;
{{/if}}

namespace {{{Namespace}}}
{
{{#if ValidatesToken}}
    [Authorize]
{{/if}}
    [ApiController]
    public class {{{Name}}}Controller : ControllerBase
    {
        private readonly ICommandDispatcher _dispatcher;

        public {{{Name}}}Controller(ICommandDispatcher dispatcher)
        {
            _dispatcher = dispatcher;
        }

        [Route("{{#if HasRoute}}{{Route}}{{/if}}")]
        {{{httpVerbs}}}
        {{#if CommandHasResult}}
        public async Task<ActionResult<{{{CommandResultTypeName}}}>> Handler(
        {{else}}
        public async Task<ActionResult> Handler(
        {{/if}}
        {{#if IsBodyBased}}
            {{#if CommandRequiresBody}}
            [FromBody]{{{CommandTypeName}}} command
            {{/if}}
        {{else}}
            // need to get query parameters
            {{#each QueryParameters}}
                {{#if @index}},{{/if}} {{{TypeName}}} param{{@index}}
            {{/each}}
        {{/if}}
        )
        {
            {{#if IsBodyBased}}
                {{#unless CommandRequiresBody}}
                    {{{CommandTypeName}}} command = CreateNewCommand();
                {{/unless}}
            {{else}}
            {{{CommandTypeName}}} command = CreateNewCommand();
            {{/if}}
            {{#if CommandHasResult}}
            {{{CommandResultTypeName}}} result = (await _dispatcher.DispatchAsync(command)).Result;
            return new OkObjectResult(result);
            {{else}}
            await _dispatcher.DispatchAsync(command);
            return new OkResult();
            {{/if}}
        }

        private static {{{CommandTypeName}}} CreateNewCommand()
        {
            {{#if UsesImmutableTypes}}
                {{#if CommandTypeIsUnit}}
                    return null;
                {{else}}    
                return new {{{CommandTypeName}}}(
                    {{#each ImmutableTypeConstructorParameters}}
                        {{#if IsFSharpOptionType}}
                            Microsoft.FSharp.Core.FSharpOption<{{{FSharpOptionInnerTypeName}}}>.None
                        {{else}}
                            default({{{TypeName}}})
                        {{/if}}
                        {{#unless @last}},{{/unless}}
                    {{/each}}
                );
                {{/if}}    
            {{else}}
                return new {{{CommandTypeName}}}();
            {{/if}}
        }
    }
}
