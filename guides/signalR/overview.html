<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>SignalR </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="SignalR ">
    <meta name="generator" content="docfx 2.48.0.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" width="56" height="52" src="../../images/largeLogo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="signalr">SignalR</h1>

<p>The following assumes a basic familiarity with serverless SignalR as <a href="https://docs.microsoft.com/en-us/azure/azure-signalr/signalr-concept-azure-functions">can be found in this guide here</a>.</p>
<p>The examples below use <a href="/crosscutting/connectionStrings.md">default connection strings</a>.</p>
<p>Before beginning you will need to install the Function Monkey SignalR package to your Functions project:</p>
<pre><code>Install-Package FunctionMonkey.SignalR
</code></pre><h2 id="providing-a-client-with-an-access-token-and-endpoint">Providing a client with an access token and endpoint</h2>
<p>For a client to be able to listen for SignalR events it needs to connect to the SignalR hub and to do this it requires the URL of the hub and an access token. This is generally provided over an HTTP endpoint and typically behind some form of authentication / authorization mechanism.</p>
<p>Function Monkey provides two ways for you to implement such an endpoint.</p>
<h3 id="using-a-binding-expression">Using a binding expression</h3>
<p>Function Monkey allows for the access token and endpoint to be returned using the same approach as Azure Functions. For example here is the standard Azure Functions approach to returning the token:</p>
<pre><code>[FunctionName(&quot;negotiate&quot;)]
public static SignalRConnectionInfo Negotiate(
    [HttpTrigger(AuthorizationLevel.Anonymous)]HttpRequest req, 
    [SignalRConnectionInfo
        (HubName = &quot;chat&quot;, UserId = &quot;{headers.x-ms-client-principal-id}&quot;)]
        SignalRConnectionInfo connectionInfo)
{
    // connectionInfo contains an access key token with a name identifier claim set to the authenticated user
    return connectionInfo;
}
</code></pre><p>This returns an access token for the hub called chat and with a user ID that is populated from the x-ms-client-principal-id header (this is a header set by the App Service easy auth system).</p>
<p>The Function Monkey equivelant of this looks like the below:</p>
<pre><code>public class FunctionAppConfiguration : IFunctionAppConfiguration
{
    public void Build(IFunctionHostBuilder builder)
    {
        builder
            .Functions(functions =&gt; functions
                .SignalR(signalR =&gt; signalR
                    .Negotiate(&quot;/negotiate&quot;, &quot;chat&quot;, &quot;{headers.x-ms-client-principal-id}&quot;)
                )
            );
    }
}
</code></pre><p>Note that the user ID binding expression is optional.</p>
<h2 id="using-a-command">Using a command</h2>
<p>If, for example, the user ID is not available in a header but instead is in, for example, a database or a claim then Function Monkey also includes the ability for the access token to be returned by way of a command. In this case the <em>IFunctionAppConfiguration</em> looks like the below:</p>
<pre><code>public class FunctionAppConfiguration : IFunctionAppConfiguration
{
    public void Build(IFunctionHostBuilder builder)
    {
        builder
            .Functions(functions =&gt; functions
                .SignalR(signalR =&gt; signalR
                    .Negotiate&lt;SignalRNegotiateCommand&gt;(&quot;/negotiate&quot;)
                )
            );
    }
}
</code></pre><p>The SignalRNegotiateCommand must return a <em>SignalRNegotiateResponse</em> as shown below:</p>
<pre><code>public class SignalRNegotiateCommand : ICommand&lt;SignalRNegotiateResponse&gt;
{

}
</code></pre><p>An implementation for this in a command handler (using hard coded values) could look like the below:</p>
<pre><code>internal class NegotiateCommandHandler : ICommandHandler&lt;SignalRNegotiateCommand, SignalRNegotiateResponse&gt;
{
    public Task&lt;SignalRNegotiateResponse&gt; ExecuteAsync(NegotiateCommand command, SignalRNegotiateResponse previousResult)
    {
        return Task.FromResult(new SignalRNegotiateResponse
        {
            HubName = &quot;myhub&quot;,
            UserId = &quot;1234&quot;
        });
    }
}
</code></pre><h2 id="sending-messages-to-clients">Sending messages to clients</h2>
<p>Sending messages to SignalR clients is accomplished through an output binding. The example below illustrates how to configure Function Monkey to send a message in response to processing an item from a Service Bus queue:</p>
<pre><code>public class FunctionAppConfiguration : IFunctionAppConfiguration
{
    public void Build(IFunctionHostBuilder builder)
    {
        builder
            .Functions(functions =&gt; functions
                .ServiceBus(serviceBus =&gt; serviceBus
                    .QueueFunction&lt;ProcessOrderCommand&gt;(&quot;orderQueue&quot;)
                    .OutputTo.SignalRMessage(&quot;myhub&quot;)  
                )
            );
    }
}
</code></pre><p>Commands that send SignalR messages must have a return type of <em>SignalRMessage</em>:</p>
<pre><code>public class ProcessOrderCommand : ICommand&lt;SignalRMessage&gt;
{
    public string OrderNumber { get; set; }

    public string OrderedByUserId { get; set; }
}
</code></pre><p>And a simple handler for this would take the following form:</p>
<pre><code>internal class ProcessOrderCommandHandler : ICommandHandler&lt;ProcessOrderCommand, SignalRMessage&gt;
{
    public Task&lt;SignalRMessage&gt; ExecuteAsync(ProcessOrderCommand command, SignalRMessage previousResult)
    {
        return Task.FromResult(new SignalRMessage
        {
            Arguments = new object[] { command.OrderNumber },
            GroupName = null,
            Target = &quot;orderProcessedNotification&quot;,
            UserId = command.OrderedByUserId
        });
    }
}
</code></pre><p>The <em>GroupName</em> property can be set to the name of any SignalR group (see below) and the <em>UserId</em> property is optional. If it is not set then the message will be sent to all users.</p>
<h2 id="adding-and-removing-users-from-groups">Adding and removing users from groups</h2>
<p>Adding and removing users from groups takes a similar form to sending messages and is again accomplished through an output binding:</p>
<pre><code>public class FunctionAppConfiguration : IFunctionAppConfiguration
{
    public void Build(IFunctionHostBuilder builder)
    {
        builder
            .Functions(functions =&gt; functions
                .ServiceBus(serviceBus =&gt; serviceBus
                    .QueueFunction&lt;AddUserToMarketingGroupCommand&gt;(&quot;userManagementQueue&quot;)
                    .OutputTo.SignalRMessage(&quot;myhub&quot;)  
                )
            );
    }
}
</code></pre><p>Commands that manipulate SignalR groups must have a return type of <em>SignalRGroupAction</em>:</p>
<pre><code>public class AddUserToMarketingGroupCommand : ICommand&lt;SignalRGroupAction&gt;
{
    public string UserId { get; set; }
}
</code></pre><p>And a simple handler for this would take the following form:</p>
<pre><code>internal class AddUserToMarketingGroupCommandHandler : ICommandHandler&lt;AddUserToMarketingGroupCommand, SignalRMessage&gt;
{
    public Task&lt;SignalRGroupAction&gt; ExecuteAsync(AddUserToMarketingGroupCommand command, SignalRGroupAction previousResult)
    {
        return Task.FromResult(new SignalRGroupAction
        {
            Action = GroupActionEnum.Add,
            GroupName = &quot;marketingInfo&quot;,
            UserId = command.UserId
        });
    }
}
</code></pre><h2 id="signalrmessage-and-signalrgroupaction">SignalRMessage and SignalRGroupAction</h2>
<p>These two POCOs have exactly the same form as those that can be found in the Azure Functions WebJobs extension package but live inside the FunctionMonkey.Abstractions package and you must take care to ensure you use these classes.</p>
<p>The reason I&#39;ve cloned the POCOs like this is because the Azure Functions variants are bundled inside the extension package that has a large number of dependencies that are not appropriate in the business / domain tier of an application.</p>
<p>Hopefully in time more teams within Microsoft will adopt the *.Abstractions form for packages.</p>
<div id="disqus_thread"></div>
            </article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/JamesRandall/FunctionMonkey/blob/master/docfx/guides/signalR/overview.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                  <li>
                    <a href="#disqus_thread" class="contribution-link">0 Comments</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            Copyright © 2018 James Randall
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
    <script id="dsq-count-scr" src="//docfx-github.disqus.com/count.js" async=""></script>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-20735760-7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-20735760-7');
    </script>
    
    <script defer="" src="https://use.fontawesome.com/releases/v5.0.10/js/all.js" integrity="sha384-slN8GvtUJGnv6ca26v8EzVaR9DC58QEwsIk9q1QXdCU8Yu8ck/tL/5szYlBbqmS+" crossorigin="anonymous"></script>  </body>
</html>
