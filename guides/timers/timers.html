<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Timers </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Timers ">
    <meta name="generator" content="docfx 2.40.1.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" width="56" height="52" src="../../images/largeLogo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="timers">Timers</h1>

<p>First begin by creating an empty Azure Functions v2 project and then install the core nuget packages for Function Monkey:</p>
<pre><code>Install-Package FunctionMonkey -pre
Install-Package FunctionMonkey.Compiler -pre
</code></pre><p>Now create a folder in the solution called commands and create a class called SendEmailCommand:</p>
<pre><code>public class CleanupCommand : ICommand
{

}
</code></pre><p>Next create a folder in the solution called Handlers and create a class called SendEmailCommandHandler:</p>
<pre><code>internal class CleanupCommandHandler : ICommandHandler&lt;CleanupCommand&gt;
{
    public Task ExecuteAsync(CleanupCommand command)
    {
        // We won&#39;t really do anything here in this example
        return Task.CompletedTask;
    }
}
</code></pre><p>And now we&#39;ll create our function app configuration in the root of the project that registers the command handler and registers the command with a 5 minute timer:</p>
<pre><code>public class FunctionAppConfiguration : IFunctionAppConfiguration
{
    private const string QueueName = &quot;sendEmailQueue&quot;;
    private const string ServiceBusConnectionName = &quot;serviceBusConnection&quot;;

    public void Build(IFunctionHostBuilder builder)
    {
        builder
            .Setup((serviceCollection, commandRegistry) =&gt;
                commandRegistry.Register&lt;CleanupCommandHandler&gt;()
            )
            .Functions(functions =&gt; functions
                .Timer&lt;CleanUpCommand&gt;(&quot;0 */5 * * * *)
                )
            );
    }
}
</code></pre><p>And thats it! If you run this project you should find that the <em>CleanUpCommandHandler</em> runs every 5 minutes.</p>
<h2 id="creating-commands-with-payloads">Creating Commands With Payloads</h2>
<p>In the above example the CleanupCommand was created using its default constructor - if you want to create commands with populated properties then you can use a timer command factory.</p>
<p>First lets expand our command class to include a property:</p>
<pre><code>public class CleanupCommand : ICommand
{
    public bool IsItUrgent { get; set; }
}
</code></pre><p>And now we need to create a factory class, to do this we must implement the <em>ITimerCommandFactory<tcommand></tcommand></em> interface:</p>
<pre><code>internal class CleanupCommandTimerCommandFactory : ITimerCommandFactory&lt;CleanupCommand&gt;
{
    public CleanupCommand Create(string cronExpression)
    {
        return new CleanupCommand { IsItUrgent = true };
    }
}
</code></pre><p>And finally update our function app configuration to instruct the function to use the factory:</p>
<pre><code>public class FunctionAppConfiguration : IFunctionAppConfiguration
{
    private const string QueueName = &quot;sendEmailQueue&quot;;
    private const string ServiceBusConnectionName = &quot;serviceBusConnection&quot;;

    public void Build(IFunctionHostBuilder builder)
    {
        builder
            .Setup((serviceCollection, commandRegistry) =&gt;
                commandRegistry.Register&lt;CleanupCommandHandler&gt;()
            )
            .Functions(functions =&gt; functions
                .Timer&lt;CleanUpCommand, CleanupCommandTimerCommandFactory&gt;(&quot;0 */5 * * * *)
                )
            );
    }
}
</code></pre><p>And if you run this you should find your command handler is called with the IsItUrgent flag set to true. Timer command factories are created by the IoC container and so can have additional interfaces injected into them to source any relavant information.</p>
<div id="disqus_thread"></div>
            </article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/JamesRandall/FunctionMonkey/blob/master/docfx/guides/timers/timers.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                  <li>
                    <a href="#disqus_thread" class="contribution-link">0 Comments</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            Copyright © 2018 James Randall
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
    <script id="dsq-count-scr" src="//docfx-github.disqus.com/count.js" async=""></script>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-20735760-7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-20735760-7');
    </script>
    
    <script defer="" src="https://use.fontawesome.com/releases/v5.0.10/js/all.js" integrity="sha384-slN8GvtUJGnv6ca26v8EzVaR9DC58QEwsIk9q1QXdCU8Yu8ck/tL/5szYlBbqmS+" crossorigin="anonymous"></script>  </body>
</html>
